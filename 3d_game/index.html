<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>3d game</title><style>body{margin:0;overflow:hidden;}</style></head><body><h1>3d game</h1><canvas id="raycastingCanvas" width="500" height="500" style="float:left;border:1px solid #000000"></canvas><canvas id="fpmap" width="500" height="500" style="float:left;border:1px solid #000000"></canvas><script>const viewAngle=90;viewStartAngle=270;function checkCollision(x,y,r){const ptX=Math.floor(x/blockSize.x),ptY=Math.floor(y/blockSize.y);for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){let tileX=ptX+dx,tileY=ptY+dy;if(tileX>=0&&tileX<map1[0].length&&tileY>=0&&tileY<map1.length)if(map1[tileY][tileX]==="1"){let wallX=tileX*blockSize.x,wallY=tileY*blockSize.y;if(x+r>wallX&&x-r<wallX+blockSize.x&&y+r>wallY&&y-r<wallY+blockSize.y)return true}}return false}const map1=["111111111111111111111111111111111111","100100000000000011111100000000000001","100100111111111110000100000100111111","100100000000000010000100000000000001","100111111111110010000000000000000001","100100000000000011111100000000000001","100100000000000010000100000000000001","100100000000000010000100000100000001","100000000000000010000000000100000000","100000000000000011111100000000000000","100000000000000000000000000000000001","100000000000000000000000000000000001","111111111111111111111111111111111111"],moveAmount=2,padUp=false,padDown=false,padLeft=false,padRight=false;let wallsNeedRedraw=true,canvas=document.getElementById("raycastingCanvas"),context=canvas.getContext("2d"),canvas3d=document.getElementById("fpmap"),cx3d=canvas3d.getContext("2d"),canvasWidth=canvas.width=500,canvasHeight=canvas.height=500,offsetX=canvas.offsetLeft,offsetY=canvas.offsetTop,player={x:440,y:425},badguy1={x:440,y:180,width:30,height:30,img:new Image()};badguy1.img.crossOrigin="Anonymous";badguy1.img.src="enemy1.png";let wall3dRayWidth=canvas3d.width/viewAngle;let degreeToRadian=d=>d/180*Math.PI;let Vector=function(x,y){this.x=x,this.y=y};Vector.fromAngle=function(a,v){v=v||new Vector();v.x=Math.cos(a),v.y=Math.sin(a);return v};Vector.dist=(v1,v2)=>{let dx=v1.x-v2.x,dy=v1.y-v2.y;return Math.sqrt(dx*dx+dy*dy)};Vector.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+(this.z||0)*(this.z||0))};Vector.prototype.div=function(v){if(typeof v==="number"){this.x/=v,this.y/=v,this.z/=v}else{this.x/=v.x,this.y/=v.y,this.z/=v.z}};Vector.prototype.normalize=function(){let m=this.mag();m>0&&this.div(m)};let Boundary=function(aVec,bVec,imgObj=null){this.a=aVec,this.b=bVec,this.imgObj=imgObj};Boundary.prototype.draw=function(ctx){ctx.beginPath(),ctx.moveTo(this.a.x,this.a.y),ctx.lineTo(this.b.x,this.b.y),ctx.strokeStyle=this.imgObj?"rgba(255, 0, 0, 1)":"rgba(0, 0, 0, 1)",ctx.stroke()};let Ray=function(pos,angle){this.pos=pos,this.dir=Vector.fromAngle(angle)};Ray.prototype.cast=function(b){const x1=b.a.x,y1=b.a.y,x2=b.b.x,y2=b.b.y,x3=this.pos.x,y3=this.pos.y,x4=this.pos.x+this.dir.x,y4=this.pos.y+this.dir.y,den=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);if(den===0)return;let t=((x1-x3)*(y3-y4)-(y1-y3)*(x3-x4))/den,u=-((x1-x2)*(y1-y3)-(y1-y2)*(x1-x3))/den;return t>0&&t<1&&u>0?new Vector(x1+t*(x2-x1),y1+t*(y2-y1)):void 0};let Particle=function(pos,divisor){this.pos=pos};Particle.prototype.update=function(x,y){this.pos.x=x,this.pos.y=y,this.rays=[],this.divisor=0.1;for(let a=viewStartAngle-(viewAngle/2);a<viewStartAngle+(viewAngle/2);a+=this.divisor)this.rays.push(new Ray(this.pos,degreeToRadian(a)))};Particle.prototype.look=function(ctx,walls){wall3dRayWidth=canvas3d.width/this.rays.length;let ch=canvas3d.height,maxHeight=ch*1.5;for(let i=0;i<this.rays.length;i++){let closest=null,record=Infinity,curretWall=null,closestBg,distBg;for(let w of walls){const pt=this.rays[i].cast(w);if(pt){const d=Vector.dist(this.pos,pt);if(d<record){record=d,closest=pt;if(w.imgObj){curretWall=w,closestBg=pt,distBg=d}}}}if(closest){ctx.beginPath(),ctx.moveTo(this.pos.x,this.pos.y),ctx.lineTo(closest.x,closest.y),ctx.strokeStyle='rgba(50, 80, 100, .4)',ctx.stroke();let rayAngle=Math.atan2(closest.y-this.pos.y,closest.x-this.pos.x),viewingAngle=degreeToRadian(viewStartAngle),deltaAngle=Math.atan2(Math.sin(rayAngle-viewingAngle),Math.cos(rayAngle-viewingAngle)),correctedDist=record*Math.cos(deltaAngle),height=Math.min((ch/correctedDist)*50,maxHeight);height=Math.max(height,2),cx3d.beginPath(),cx3d.moveTo(i*wall3dRayWidth,ch/2-(height/2)),cx3d.lineTo(i*wall3dRayWidth,ch/2+(height/2)),cx3d.strokeStyle=`rgba(50, 50, ${Math.min(255,height)}, 0.5)`,cx3d.stroke(),curretWall&&curretWall.imgObj&&(function(){let bgHeight=Math.min((ch/(distBg*Math.cos(deltaAngle)))*50,maxHeight),xCrop=closestBg.x-curretWall.a.x,tempCanvas=document.createElement("canvas");tempCanvas.width=1,tempCanvas.height=curretWall.imgObj.height;let tempCtx=tempCanvas.getContext("2d");tempCtx.drawImage(curretWall.imgObj.img,xCrop,0,1,curretWall.imgObj.height,0,0,1,curretWall.imgObj.height);let imageData=tempCtx.getImageData(0,0,1,curretWall.imgObj.height),data=imageData.data;for(let j=0;j<data.length;j+=4)if(data[j]===255&&data[j+1]===0&&data[j+2]===255)data[j+3]=0;tempCtx.putImageData(imageData,0,0),cx3d.drawImage(tempCanvas,0,0,1,curretWall.imgObj.height,i*wall3dRayWidth,ch/2-(bgHeight/2),wall3dRayWidth,bgHeight)})()}}};Particle.prototype.draw=function(ctx){ctx.beginPath(),ctx.arc(this.pos.x,this.pos.y,5,0,2*Math.PI),ctx.strokeStyle='rgba(255, 255, 255, 1)',ctx.stroke()};function getDistance(x1,y1,x2,y2){let y=x2-x1,x=y2-y1;return Math.sqrt(x*x+y*y)};let walls=[],radius=5,blockSize={x:context.canvas.width/map1[0].length,y:context.canvas.height/map1.length};function createWalls(){walls=[],function drawWalls(ctx){ctx.strokeStyle='rgba(0, 0, 0, 1)',ctx.lineWidth=1;for(let wall of walls){ctx.beginPath(),ctx.moveTo(wall.a.x,wall.a.y),ctx.lineTo(wall.b.x,wall.b.y),ctx.stroke()}if(badguy1&&badguy1.img){ctx.drawImage(badguy1.img,badguy1.x,badguy1.y,badguy1.width,badguy1.height),walls.push(new Boundary(new Vector(badguy1.x,badguy1.y),new Vector(badguy1.x+badguy1.width,badguy1.y),badguy1))}} map1.forEach((row,rowInx)=>{let penStart=null;for(let i=0;i<=row.length;i++){if(row[i]==="1"&&penStart===null)penStart=i;else if((row[i]==="0"||i===row.length)&&penStart!==null){walls.push(new Boundary(new Vector(penStart*blockSize.x,blockSize.y*rowInx),new Vector(i*blockSize.x,blockSize.y*rowInx))),walls.push(new Boundary(new Vector(i*blockSize.x,blockSize.y*rowInx),new Vector(i*blockSize.x,blockSize.y*(rowInx+1)))),penStart=null}}});} map1.forEach((row,rowInx)=>{let penStart=penStop=null;for(i=0;i<row.length;i++){if(row.charAt(i)==1&&penStart==null)penStart=i;if(penStart!==null&&row.charAt(i)==0)penStop=i;if(i==row.length-1)penStop=i;if(penStart!=null&&penStop!=null){walls.push(new Boundary(new Vector(penStart*blockSize.x,blockSize.y*rowInx),new Vector(penStop*blockSize.x,blockSize.y*rowInx))),walls.push(new Boundary(new Vector(penStop*blockSize.x,blockSize.y*rowInx),new Vector(penStop*blockSize.x,blockSize.y*rowInx+blockSize.y))),walls.push(new Boundary(new Vector(penStop*blockSize.x,blockSize.y*rowInx+blockSize.y),new Vector(penStart*blockSize.x,blockSize.y*rowInx+blockSize.y))),walls.push(new Boundary(new Vector(penStart*blockSize.x,blockSize.y*rowInx+blockSize.y),new Vector(penStart*blockSize.x,blockSize.y*rowInx))),penStart=penStop=null}}});let particle=new Particle(new Vector(200,200),1);let main=function(){positionPlayer(),context.clearRect(0,0,canvasWidth,canvasHeight),cx3d.clearRect(0,0,canvasWidth,canvasHeight);let ch=canvas3d.height,maxHeight=ch*1.5;drawWalls(context),particle.update(player.x,player.y),particle.look(context,walls,ch,maxHeight),particle.draw(context),requestAnimationFrame(main)};badguy1.img.complete?main():badguy1.img.onload=function(){main()};function calculateXYBasedOnAngle(){}function positionPlayer(){const alpha=degreeToRadian(viewStartAngle);let newX=player.x,newY=player.y;if(padUp){newX+=moveAmount*Math.cos(alpha),newY+=moveAmount*Math.sin(alpha)}if(padDown){newX-=moveAmount*Math.cos(alpha),newY-=moveAmount*Math.sin(alpha)}!checkCollision(newX,newY,radius)&&(player.x=newX,player.y=newY),padLeft&&(viewStartAngle-=moveAmount),padRight&&(viewStartAngle+=moveAmount),viewStartAngle=(viewStartAngle+360)%360}window.addEventListener("keydown",function(e){switch(e.key){case "ArrowUp":padUp=true;break;case "ArrowDown":padDown=true;break;case "ArrowLeft":padLeft=true;break;case "ArrowRight":padRight=true;break}}),window.addEventListener("keyup",function(e){switch(e.key){case "ArrowUp":padUp=false;break;case "ArrowDown":padDown=false;break;case "ArrowLeft":padLeft=false;break;case "ArrowRight":padRight=false;break}});</script></body></html>
